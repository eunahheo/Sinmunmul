<template>
<div class="container">

<div>
  <div class="input-group input-group-lg m-5 mt-4 mb-4 ">
  <span class="input-group-text" id="inputGroup-sizing-lg">검색어</span>
  <input type="text" class="form-control " v-model="searchWord" @keyup.enter="search">
</div>

 <ul class="nav nav-tabs m-3" >
  <li class="nav-item container row" style="float: none; margin:100 auto;">
   <h3 class="">검색 결과</h3>
  </li>
 </ul>

  <main class="m-3">
    <div class="plan span--2 long--2 ">
       <h3>연관 키워드</h3>
           <div  id="word-cloud">
        </div>
    </div>

    <div class="plan span--2 long--2">
      <h3>키워드 검색량 추이 그래프</h3>
      <line-chart :data="chartData"></line-chart>

    </div>
  </main>

<ul class="nav nav-tabs m-4" >
  <li class="nav-item container row" style="float: none; margin:100 auto;">
   <h3 class="">관련 뉴스 목록</h3>
  </li>
 </ul>

<div v-if="loading" class="spinner-border text-center" style="width: 3rem; height: 3rem" role="status">
  <span class="visually-hidden">Loading...</span>
</div>

<div class="card m-3 row" style="max-width: 1140px; max-height : 180px" v-for="news in searchedData" :key="news.news_seq">
  <div class="row g-0">
    <div class="col-md-4">
      <!-- <img v-if="news.news_photo !== ''" v-bind:src="news.news_photo" class="card-img-top" style="max-height : 180px ; "  @error="replaceDefault"> -->
      <img
      v-if="news.news_photo !== ''"
      class="card-img main-card-img"
      v-bind:src="news.news_photo"
      style="max-height : 180px; object-fit: cover;" 
      alt="Card image"
      @error="replaceDefault"/>
      <img v-else src="../../../public/img/no_image.jpg" class="card-img-top" style="max-height : 180px; object-fit: contain;" @error="replaceDefault">
      
    </div>
    <div class="col-md-7">
      <div class="card-body">
        <h5 class="card-title px-4">{{news.news_Title}} </h5>
        <hr style="border: solid 2px black">
        <p class="card-text px-4"><small class="text-muted">{{news.news_desc.substring(0,100)}}...</small></p>
      </div>

    </div>
    <div class="col-md-1">
      <!-- <button @click="detail">자세히 보기 </button> -->
      <!-- <a :href="detail" class="btn btn-primary" style="display:block; width:100%; height:100%; vertical-align: middle;">자세히 보기</a> -->
      <button @click="detail(news.news_seq)" class="btn btn-info"
      style="display:block; max-width: 1140px; max-height : 180px; width:100%; height:100%; vertical-align: middle;"
      >자세히 보기</button>
    </div>
  </div>
</div>

  <nav aria-label="..." class="d-flex justify-content-center mb-4 ">
      <ul class="pagination d-flex justify-content-between">
        <li v-if="start" class="page-item">
          <a class="page-link" href="#" @click="thisPage(1)">«</a>
        </li>
        <li v-else class="page-item disabled">
          <a class="page-link" href="#" tabindex="-1" aria-disabled="true">«</a>
        </li>

        <li v-if="pre" li class="page-item">
          <a class="page-link" href="#" @click="thisPage(nowPage-5)">‹</a>
        </li>
        <li v-else li class="page-item disabled">
          <a class="page-link" href="#" tabindex="-1" aria-disabled="true">‹</a>
        </li>
        <li
          v-for="pageitem in pageNumbers"
            v-bind:id="'p'+pageitem"
            v-bind:class="{' active': pageitem == nowPage}"
            :key="pageitem"
          class="page-item">
          <a class="page-link"  href="#" @click="thisPage(pageitem)">{{pageitem}}</a>
        </li>
        <li v-if="next" class="page-item">
          <a class="page-link" href="#" @click="thisPage(nowPage+5)">›</a>
        </li>
        <li v-else li class="page-item disabled">
          <a class="page-link" href="#" tabindex="-1" aria-disabled="true">›</a>
        </li>

        <li v-if="end" class="page-item">
          <a class="page-link" href="#" @click="thisPage(totalPage)">»</a>
        </li>
        <li v-else li class="page-item disabled">
          <a class="page-link" href="#" tabindex="-1" aria-disabled="true">»</a>
        </li>
      </ul>
    </nav>
    <news-modal v-bind:visible="newsVisible" :news="newsData" @close='visible=newsInit()'></news-modal>
</div>

</div>
</template>
<script>
import img from '@/assets/default.png'
import newsModal from './newsModal.vue'
import axios from 'axios'
// const LOCAL_HOST = 'http://localhost:3030/api'
const SERVER_HOST = 'https://j6a406.p.ssafy.io/api'

export default {
  data () {
    return {
      words: [
        { text: '글자1', size: 40, color: '#f6535d' },
        { text: '글자2', size: 36, color: '#377cc4' },
        { text: '글자3', size: 32, color: '#b168e0' },
        { text: '글자4', size: 28, color: '#1a9a9f' },
        { text: '글자5', size: 24, color: '#fac302' },
        { text: '글자6', size: 24, color: '#d86898' },
        { text: '글자7', size: 24, color: '#f9870e' },
        { text: '글자8', size: 18, color: '#6E6E6E' },
        { text: '글자9', size: 18, color: '#6E6E6E' },
        { text: '글자10', size: 18, color: '#6E6E6E' },
        { text: '글자11', size: 18, color: '#6E6E6E' },
        { text: '글자12', size: 18, color: '#6E6E6E' },
        { text: '글자13', size: 18, color: '#6E6E6E' },
        { text: '글자14', size: 18, color: '#6E6E6E' },
        { text: '글자15', size: 18, color: '#6E6E6E' },
        { text: '글자16', size: 18, color: '#6E6E6E' },
        { text: '글자17', size: 18, color: '#6E6E6E' },
        { text: '글자18', size: 18, color: '#6E6E6E' },
        { text: '글자19', size: 18, color: '#6E6E6E' },
        { text: '글자20', size: 18, color: '#6E6E6E' }
      ],

      searchWord: null,
      newsData: {},
      newsVisible: false,
      searchedData: [],
      pageNumbers: [1, 2, 3, 4, 5],
      page: 1, // 기본 1페이지
      totalPage: '',
      totalCount: '',
      nowPage: 1,
      startPage: '',
      endPage: '',
      pre: false,
      next: false,
      start: false,
      end: false,
      chartData :[{name: '',  data: {}}],

    }
  },
  components: {
    newsModal
  },
  created () {
    this.searchWord = this.$route.params.searchWord
    this.wordcloud()
    this.chartMake(this.searchWord)
    this.search()
  },

  methods: {
    genLayout () {
      const cloud = require('d3-cloud')
      cloud()
        .words(this.words)
        .padding(1)
        .rotate(0)
        .font('serif')
        .fontSize(function (d) {
          return d.size
        })
        .on('end', this.wordcloudend)
        .spiral('archimedean')
        .start()
        .stop()
    },
    wordcloudend (words) {
      console.log(words)
      const d3 = require('d3')
      const width = 600
      const height = 300
      d3.select('#word-cloud')
        .html('')
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .style('background', 'white')
        .append('g')
        .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')') // g를 중심으로 단어그림 svg 중심으로 이동
        .selectAll('text')
        .data(words)
        .enter()
        .append('text')
        .attr('class', (d) => { return d.text })
        .style('font-size', (d) => { return d.size + 'px' })
        .style('cursor', 'pointer')
        .style('fill', (d) => { return d.color }) // 색지정
        .style('fill-opacity', 1) // 투명도 조절
        .style('font-family', 'Impact')
        .style('font-weight', 'bold')
        .attr('text-anchor', 'middle')
        .attr('transform', (d) => { return 'translate(' + [d.x * 1.2, d.y * 1.2] + ') rotate (' + d.rotate + ')' })
        .text((d) => d.text)
    },

    wordcloud () { // 키워드 연관어 받아오는 api 호출
      axios({
        method: 'get',
        url: 'https://j6a406.p.ssafy.io/fapi/news/search/wordcloud',
        params:
        { keyword: this.searchWord }
      })
        .then((res) => {
          const data = res.data.data

          for (let index = 0; index < 20; index++) {
            this.words[index].text = data[index].keyword
          }
          console.log(res)
          this.genLayout()
        })
        .catch((err) => {
          console.log(err)
        })
    },
    detail (seq) {
      // console.log("검색 시퀀스 : "+seq);
       axios.get(`${SERVER_HOST}/news/detail`, {
          params: {
            newsSeq : seq,
          }
        })
        .then((res) => {
            //  console.log(res.data.data);
            this.newsData = res.data.data;
            this.newsVisible = !this.newsVisible;

        }).catch((err) => {
            console.log("에러");
            console.log(err);
          });

    },
    newsInit: function () {
       this.newsVisible = false;
    },
    search() {
      // console.log("검색 키워드 확인 : "+this.searchWord);
      if(this.searchWord != null && this.searchWord !="") {
        this.loading = true;
        axios.get(`${SERVER_HOST}/news/keyword`, {
          params: {
            keyword : this.searchWord,
            page : this.nowPage,
            size : 10,
          }
        })
        .then((res) =>{
          console.log(res.data);
          this.searchedData = res.data.data;
          const totalElements = res.data.data[0].totalElements;
          this.pagination(totalElements);
          this.chartMake(this.searchWord);
          this.loading = false;
        }).catch((err) => {
          console.log("에러");
          alert("검색 결과가 없습니다.");
          console.log(err);
          this.loading = false;
          })
      }
    },
    pagination: function (total) {
      this.totalPage = parseInt(total / 6)
      if ((total % 6) !== 0) {
        this.totalPage = this.totalPage + 1
      }
      this.startPage = (parseInt((this.nowPage - 1) / 5)) * 5 + 1
      this.endPage = this.startPage + 4

      if (this.endPage > this.totalPage) {
        this.endPage = this.totalPage
      }
      this.pre = false
      this.start = false

      if ((this.nowPage - 5) >= 1) {
        this.pre = true
      }
      if (this.startPage > 5) {
        this.start = true
      }
      this.next = false
      this.end = false

      if (this.endPage < this.totalPage) {
        this.next = true
        this.end = true
      }

      const s = this.startPage
      const e = this.endPage
      for (let i = s; i <= e; i++) {
        this.pageNumbers[i - s] = i

      }
    },
    thisPage: function (num) {
      if (num > this.totalPage) {
        num = this.totalPage
      }

      this.nowPage = num
      this.search();
    },

    replaceDefault: function (e) {
      e.target.src = img
    },

    chartMake(keyword) {
     // console.log("차트 검색 키워드 "+keyword);
      axios.get(`${SERVER_HOST}/news/keyword/trend/week`, {
          params: {
            keywords : keyword,
          }
        })
        .then((res) =>{

      this.chartData = [ {name: '',  data: {   }}]; //할당 안해주면 data 표시 안됨
      var values = Object.values(res.data.data[0].stat); //받은 result value들만 따로 정제
      var temp = {}; //value를 속성, 값으로 만들어줄 객체

      for(var i =0; i<values.length; i++)  {
        let label = values[i].label;
        temp[label] = values[i].count; //temp 객체에 label 속성과 count 값 할당
      }

      //차트 데이터 할당
      this.chartData[0].name = keyword;
      this.chartData[0].data = temp;

       console.log(this.chartData);

      }).catch((err) => {
            console.log("에러");
            alert("검색 결과가 없습니다.");
            console.log(err);
          })
    },

  }

}

</script>
<style scoped>
@media (min-width: 700px) {
  main {
    display: grid;
    grid-template-columns: repeat(3, 1fr) 25%;
    grid-template-rows: repeat(3, auto);
    grid-gap: 1.2rem;
  }
}

.span--2 {
  grid-column: span 2;
}

.long--2 {
  grid-row: span 2;
}

.long--4 {
  grid-row: span 4;
}
#word-cloud {
  /* border  : 1px solid blue; */
   -webkit-border-radius: 10px;
  -moz-border-radius: 10px;
   border-radius: 10px;
  -webkit-box-shadow: 0 8px 20px 0 rgba(0, 0, 0, 0.1);
  -moz-box-shadow: 0 8px 20px 0 rgba(0, 0, 0, 0.1);
  box-shadow: 0 8px 20px 0 rgba(0, 0, 0, 0.1)

}

bar-chart {
height:400px;

}


</style>
